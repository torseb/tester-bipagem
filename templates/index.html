<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Server-Side Bipagem 30k</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"/>
  <style>
    .bipado { background-color: #d4edda !important; }
    .nao-bipado { background-color: #f8d7da !important; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-primary mb-3">
  <div class="container"><span class="navbar-brand">Bipagem 30k</span></div>
</nav>
<div class="container">
  {% if mensagem %}<div class="alert alert-info">{{ mensagem }}</div>{% endif %}

  <div class="row gy-4">
    <!-- 1. Carregar Base -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">1. Carregar Base</div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            <input type="hidden" name="acao" value="carregar_base"/>
            <input type="file" name="file" class="form-control mb-2" required/>
            <input type="text" name="loja" class="form-control mb-2" placeholder="Loja (opcional)"/>
            <button class="btn btn-primary w-100">Carregar</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 2. Importar Bipados -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">2. Importar Bipados</div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            <input type="hidden" name="acao" value="importar_bipados"/>
            <input type="file" name="file" class="form-control mb-2" required/>
            <input type="text" name="loja" class="form-control mb-2" placeholder="Loja (opcional)"/>
            <input type="text" name="local" class="form-control mb-2" placeholder="Local (opcional)"/>
            <button class="btn btn-success w-100">Importar</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 3. Bipagem Manual -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header">3. Bipagem Manual</div>
        <div class="card-body">
          <form method="post" id="form-bipar">
            <input type="hidden" name="acao" value="bipagem_manual"/>
            <input id="codigo_barras" name="codigo_barras" class="form-control mb-2" placeholder="EAN ou interno"/>
            <input type="text" name="loja" class="form-control mb-2" placeholder="Loja (opcional)"/>
            <button class="btn btn-warning w-100">Bipar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtro e downloads -->
  <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
    <div>
      <label class="me-2">Mostrar:</label>
      <select id="filtro" class="form-select form-select-sm d-inline-block w-auto">
        <option value="todos">Todos</option>
        <option value="bipado">Bipados</option>
        <option value="nao-bipado">Não Bipados</option>
      </select>
    </div>
    <div class="btn-group btn-group-sm">
      <a href="/download_csv" class="btn btn-outline-primary">CSV Todos</a>
      <a href="/download_csv_bipados" class="btn btn-outline-success">CSV Bipados</a>
      <a href="/download_csv_nao_bipados" class="btn btn-outline-danger">CSV Não-Bipados</a>
    </div>
  </div>

  <table id="tbl" class="table table-striped table-bordered w-100">
    <thead class="table-primary">
      <tr>
        <th>nome</th><th>codigo_interno</th><th>ean</th><th>fornecedor</th>
        <th>quantidades</th><th>bipado</th><th>data_bipagem</th><th>localizacao</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
$(function(){
  var table=$('#tbl').DataTable({
    serverSide:true,processing:true,ajax:'/data',
    columns:[
      {data:'nome'},{data:'codigo_interno'},{data:'ean'},{data:'fornecedor'},
      {data:'quantidades'},{data:'bipado',render:v=>v?'Sim':'Não'},{data:'data_bipagem'},{data:'localizacao'}
    ],
    pageLength:100,lengthMenu:[[100,500,1000],[100,500,1000]],
    rowCallback:function(r,d){$(r).toggleClass('bipado',d.bipado==1).toggleClass('nao-bipado',d.bipado==0)},
    language:{search:'Buscar:',lengthMenu:'Mostrar _MENU_',info:'_START_ a _END_ de _TOTAL_',paginate:{first:'<<',last:'>>',next:'>',previous:'<'}}
  });
  $.fn.dataTable.ext.search.push(function(_,__,idx){
    var f=$('#filtro').val(),r=$(table.row(idx).node());
    return f=='todos'||(f=='bipado'&&r.hasClass('bipado'))||(f=='nao-bipado'&&r.hasClass('nao-bipado'));
  });
  $('#filtro').on('change',function(){table.draw();});
});
</script>